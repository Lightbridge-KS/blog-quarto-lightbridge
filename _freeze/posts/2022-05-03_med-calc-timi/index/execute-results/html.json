{
  "hash": "c763490eb21be498b88f25f9eee95acf",
  "result": {
    "markdown": "---\ntitle: \"TIMI Risk Score for STEMI\"\nsubtitle: \"A Simple Calculator\"\ndescription: \"How to program a simple TIMI risk score calculator for STEMI\"\ndate: \"2022-05-03\"\ndraft: false # Will render locally only\ncategories: [\"R\", \"Med\", \"Calculator\"]\ntags: \n  - \"DIY\"\nimage: feature.jpg\nbibliography: \"references.bib\"\n---\n\n\n\nToday, I build a simple program to calculate TIMI Risk Score for STEMI [@Morrow2000-us] using R code.\n\nThe calculator will simply base on this table chart.\n\n![](img/TIMI-card.png){#fig-card fig-alt=\"TIMI-card\"}\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)\ntheme_set(theme_bw())\n```\n:::\n\n# Design\n\nDesign motivation came from a TIMI Risk Score for STEMI from [mdcalc](https://www.mdcalc.com/timi-risk-score-stemi#creator-insights).\n\n## Main Function: `TIMI_calc()`\n\nFunction's Parameter\n\nHistorical\n\n-   `age`: (int) Age in years\n-   `DM`: (lgl) Any DM ?\n-   `HTN`: (lgl) Any HTN ?\n-   `angina`: (lgl) Any angina ?\n\nExam\n\n-   `SBP`: (dbl) Systolic Blood Pressure (mmHg)\n-   `HR`: (dbl) Heart Rate (bpm)\n-   `Killip`: (lgl) Killip Class form 1 - 4\n-   `wt`: (dbl) Weight in kg\n\nPresentation\n\n-   `Ant_STE`: (lgl) Anterior STE ?\n-   `LBBB`: (lgl) LBBB ?\n-   `time_to_rx`: (dbl) time to treatment (hr)\n\nReturn value: A data frame with 3 columns:\n\n-   `risk.score`: TIMI risk score\n-   `odds.death.30d`: estimated odds of death by 30 day.\n-   `p.death.30d`: estimated probability of death by 30 day.\n\n## Helper Function\n\nSince the original table reports as *odds* not a probability of death by 30 day. We need to write a function to convert odds to probability.\n\nOdds of death is a ratio of the probability of death to the probability of survival; we can write the @eq-odds ($p$ denotes the probability of death).\n\n$$\nodd = \\frac{p}{1-p}\n$$ {#eq-odds}\n\nRearranging terms $p$ to the left, we get:\n\n$$\np = \\frac{odd}{odd + 1}\n$$\n\nTherefore we can write function `odds_to_prob()`.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nodds_to_prob <- function(odds) odds / (odds + 1)\n```\n:::\n\n## Lookup Table\n\n`risk_df` is a lookup table that maps risk score to the odds and probability of death.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nrisk_df <- tibble::tibble(\n  risk.score = 0:8,\n  odds.death.30d = c(0.1, 0.3, 0.4, 0.7, 1.2, 2.2, 3, 4.8, 5.8)\n  ) %>% \n  # Test Convert Odds to Probability\n  mutate(p.death.30d = odds_to_prob(odds.death.30d))\n\nrisk_df\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> risk.score </th>\n   <th style=\"text-align:right;\"> odds.death.30d </th>\n   <th style=\"text-align:right;\"> p.death.30d </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.1 </td>\n   <td style=\"text-align:right;\"> 0.0909091 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.3 </td>\n   <td style=\"text-align:right;\"> 0.2307692 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 0.4 </td>\n   <td style=\"text-align:right;\"> 0.2857143 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 0.7 </td>\n   <td style=\"text-align:right;\"> 0.4117647 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 1.2 </td>\n   <td style=\"text-align:right;\"> 0.5454545 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 2.2 </td>\n   <td style=\"text-align:right;\"> 0.6875000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 3.0 </td>\n   <td style=\"text-align:right;\"> 0.7500000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 4.8 </td>\n   <td style=\"text-align:right;\"> 0.8275862 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 5.8 </td>\n   <td style=\"text-align:right;\"> 0.8529412 </td>\n  </tr>\n</tbody>\n</table>\n`````\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nrisk_df %>% \n  ggplot(aes(risk.score, p.death.30d, color = risk.score)) +\n  geom_point(alpha = 0.8, size = 3, show.legend = F) +\n  geom_smooth(se = FALSE, size = 0.5, lty = \"dashed\", show.legend = F) +\n  scale_color_viridis_c(option = \"plasma\", \n                        begin = 0.1,end = 0.8) +\n  labs(x = \"TIMI risk score\", y = \"Probability of death (30d)\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-1-1.png){fig-align='center' fig-pos='h' width=1800}\n:::\n:::\n\n\nKeep in mind that if risk score is \\> 8, the odds of death by 30 day would be 8.8 but this would be impossible to include in the data frame.\n\n# Get Score\n\nFirst, let's start building `get_TIMI_score()` to calculate TIMI risk score.\n\nThe return value will be a list with:\n\n-   `total_score`: (int) a total risk score (range 0-14)\n-   `score`: a list containing individual score for each fields.\n\nNote that I use `ifelse()` because it vectorized over the inputs.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nget_TIMI_score <- function(age, DM, HTN, angina,\n                           SBP, HR, Killip, wt,\n                           Ant_STE, LBBB, time_to_rx\n                           ) {\n  \n  score <- list() # Initialize empty list to store score\n  \n  # Age â‰¥ 75 = 3 score, Age 65-75 = 2 score\n  score$age <- ifelse(age >= 75, 3L, ifelse(age >= 65, 2L, 0L))\n  # Any DM, HT, or angina give 1 score\n  score$DM_HT_angina <- ifelse(DM | HTN | angina, 1L, 0L)\n  # SBP < 100 give 3 score\n  score$SBP <- ifelse(SBP < 100, 3L, 0L)\n  # HR > 100 give 2 score\n  score$HR <- ifelse(HR > 100, 2L, 0L)\n  # Killip II-IV give 2 score\n  score$Killip <- ifelse(Killip %in% 2L:4L, 2L, 0L)\n  # Weight < 67 kg give 1 score\n  score$wt <- ifelse(wt < 67, 1L, 0L)\n  # Anterior STE or LBBB give 1 score\n  score$Ant_STE_LBBB <- ifelse(Ant_STE | LBBB, 1L, 0L)\n  # Time of rx > 4 hr give 1 score\n  score$time_to_rx <- ifelse(time_to_rx > 4, 1L, 0L)\n  ## Sum Scores\n  total_score <- as.integer(colSums(t(as.data.frame(score))))\n  \n  list(total_score = total_score, \n       score = score)\n}\n```\n:::\n\nTest getting TIMI score from input of 1 patient\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npatient1_score <- get_TIMI_score(\n  age = 60, DM = TRUE, HTN = FALSE, angina = TRUE,\n  SBP = 110, HR = 90, Killip = 1, wt = 60,\n  Ant_STE = TRUE, LBBB = FALSE, time_to_rx = 3\n)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Total Score\npatient1_score$total_score\n#> [1] 3\n# Individual Score\npatient1_score$score\n#> $age\n#> [1] 0\n#> \n#> $DM_HT_angina\n#> [1] 1\n#> \n#> $SBP\n#> [1] 0\n#> \n#> $HR\n#> [1] 0\n#> \n#> $Killip\n#> [1] 0\n#> \n#> $wt\n#> [1] 1\n#> \n#> $Ant_STE_LBBB\n#> [1] 1\n#> \n#> $time_to_rx\n#> [1] 0\n```\n:::\n\n# Calculate Odds and Probability\n\nNow the final function `TIMI_calc()` will calculate TIMI risk score, odds and probability of death by 30 days.\n\nThe return value will be a data frame.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nTIMI_calc <- function(age, DM, HTN, angina,\n                      SBP, HR, Killip, wt,\n                      Ant_STE, LBBB, time_to_rx\n                      ) {\n\n  score <- get_TIMI_score(age = age, DM = DM, HTN = HTN,\n                 angina = angina, SBP = SBP,\n                 HR = HR, Killip = Killip,\n                 wt = wt, Ant_STE = Ant_STE,\n                 LBBB = LBBB, time_to_rx = time_to_rx)\n  \n  total_score <- score$total_score\n  \n  # If the risk score > 8, odds is 8.8. If not, find odds from `risk_df`\n  odds.death.30d <- ifelse(total_score > 8, 8.8, {\n    \n    # Odds from Lookup Table\n    risk_df[total_score + 1, ]$odds.death.30d\n    \n  })\n  # Combind to Data Frame\n  data.frame(\n    risk.score = total_score,\n    odds.death.30d = odds.death.30d,\n    p.death.30d = odds_to_prob(odds.death.30d)\n  )\n  \n}\n```\n:::\n\nLet's try `TIMI_calc()`, I have designed it to be a vectorized function.\n\nTherefore, we can input arguments as vector of length \\> 1.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nTIMI_calc(age = 60:61, \n          DM = c(T, F), \n          HTN = c(F, T), \n          angina = c(T, F),\n          SBP = c(110, 130), \n          HR = c(90, 100), \n          Killip = 1:2, \n          wt = 60:61,\n          Ant_STE = c(T, F), \n          LBBB = c(T, F), \n          time_to_rx = c(3,4)\n          ) \n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> risk.score </th>\n   <th style=\"text-align:right;\"> odds.death.30d </th>\n   <th style=\"text-align:right;\"> p.death.30d </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 0.7 </td>\n   <td style=\"text-align:right;\"> 0.4117647 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 1.2 </td>\n   <td style=\"text-align:right;\"> 0.5454545 </td>\n  </tr>\n</tbody>\n</table>\n`````\n:::\n:::\n\n# Example Usage\n\nLet's say I have a `patients` data frame (simulated), which contains a collection of history, physical exams, and other presentation from, keeping it simple, 3 patients.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npatients\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> name </th>\n   <th style=\"text-align:right;\"> age </th>\n   <th style=\"text-align:left;\"> underlying </th>\n   <th style=\"text-align:left;\"> angina </th>\n   <th style=\"text-align:right;\"> SBP </th>\n   <th style=\"text-align:right;\"> HR </th>\n   <th style=\"text-align:right;\"> Killip </th>\n   <th style=\"text-align:right;\"> wt </th>\n   <th style=\"text-align:left;\"> EKG </th>\n   <th style=\"text-align:right;\"> time_to_rx </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> John </td>\n   <td style=\"text-align:right;\"> 50 </td>\n   <td style=\"text-align:left;\"> None </td>\n   <td style=\"text-align:left;\"> TRUE </td>\n   <td style=\"text-align:right;\"> 120 </td>\n   <td style=\"text-align:right;\"> 70 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 70 </td>\n   <td style=\"text-align:left;\"> Anterior STE </td>\n   <td style=\"text-align:right;\"> 2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Dave </td>\n   <td style=\"text-align:right;\"> 70 </td>\n   <td style=\"text-align:left;\"> DM </td>\n   <td style=\"text-align:left;\"> FALSE </td>\n   <td style=\"text-align:right;\"> 100 </td>\n   <td style=\"text-align:right;\"> 80 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 80 </td>\n   <td style=\"text-align:left;\"> Inferior STE </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Marty </td>\n   <td style=\"text-align:right;\"> 80 </td>\n   <td style=\"text-align:left;\"> DM, HT </td>\n   <td style=\"text-align:left;\"> TRUE </td>\n   <td style=\"text-align:right;\"> 90 </td>\n   <td style=\"text-align:right;\"> 100 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 65 </td>\n   <td style=\"text-align:left;\"> Inferior STE, LBBB </td>\n   <td style=\"text-align:right;\"> 4 </td>\n  </tr>\n</tbody>\n</table>\n`````\n:::\n:::\n\nNext, I will use `TIMI_calc()` on these data. But first, I will use some trick to convert `patients` into a cleaner data frame `patients_args` that can be passed as arguments directly.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npatients_args <- patients %>% \n  # Extract DM, HT to logical \n  mutate(\n    DM = str_detect(underlying, \"DM\"), \n    HTN = str_detect(underlying, \"HTN\"), .after = underlying\n    ) %>% \n  # Extract Ant_STE, LBBB to logical\n  mutate(\n    Ant_STE = str_detect(EKG, \"Anterior STE\"),\n    LBBB = str_detect(EKG, \"LBBB\"), .after = EKG\n  ) %>% \n  select(-name, -underlying, -EKG)\n```\n:::\n\nNow I use non-standard evaluation trick from `{rlang}` to unquote splice `patients_args` and passed as argument.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npatients_res <- rlang::exec(TIMI_calc, !!!patients_args)\npatients_res\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> risk.score </th>\n   <th style=\"text-align:right;\"> odds.death.30d </th>\n   <th style=\"text-align:right;\"> p.death.30d </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 0.4 </td>\n   <td style=\"text-align:right;\"> 0.2857143 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 0.7 </td>\n   <td style=\"text-align:right;\"> 0.4117647 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:right;\"> 8.8 </td>\n   <td style=\"text-align:right;\"> 0.8979592 </td>\n  </tr>\n</tbody>\n</table>\n`````\n:::\n:::\n\nFinally, I will bind the result into one data frame to keep track of other patient's information.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npatients %>% \n  bind_cols(patients_res) %>% \n  relocate(risk.score, odds.death.30d, p.death.30d, .after = name)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> name </th>\n   <th style=\"text-align:right;\"> risk.score </th>\n   <th style=\"text-align:right;\"> odds.death.30d </th>\n   <th style=\"text-align:right;\"> p.death.30d </th>\n   <th style=\"text-align:right;\"> age </th>\n   <th style=\"text-align:left;\"> underlying </th>\n   <th style=\"text-align:left;\"> angina </th>\n   <th style=\"text-align:right;\"> SBP </th>\n   <th style=\"text-align:right;\"> HR </th>\n   <th style=\"text-align:right;\"> Killip </th>\n   <th style=\"text-align:right;\"> wt </th>\n   <th style=\"text-align:left;\"> EKG </th>\n   <th style=\"text-align:right;\"> time_to_rx </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> John </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 0.4 </td>\n   <td style=\"text-align:right;\"> 0.2857143 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n   <td style=\"text-align:left;\"> None </td>\n   <td style=\"text-align:left;\"> TRUE </td>\n   <td style=\"text-align:right;\"> 120 </td>\n   <td style=\"text-align:right;\"> 70 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 70 </td>\n   <td style=\"text-align:left;\"> Anterior STE </td>\n   <td style=\"text-align:right;\"> 2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Dave </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 0.7 </td>\n   <td style=\"text-align:right;\"> 0.4117647 </td>\n   <td style=\"text-align:right;\"> 70 </td>\n   <td style=\"text-align:left;\"> DM </td>\n   <td style=\"text-align:left;\"> FALSE </td>\n   <td style=\"text-align:right;\"> 100 </td>\n   <td style=\"text-align:right;\"> 80 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 80 </td>\n   <td style=\"text-align:left;\"> Inferior STE </td>\n   <td style=\"text-align:right;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Marty </td>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:right;\"> 8.8 </td>\n   <td style=\"text-align:right;\"> 0.8979592 </td>\n   <td style=\"text-align:right;\"> 80 </td>\n   <td style=\"text-align:left;\"> DM, HT </td>\n   <td style=\"text-align:left;\"> TRUE </td>\n   <td style=\"text-align:right;\"> 90 </td>\n   <td style=\"text-align:right;\"> 100 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 65 </td>\n   <td style=\"text-align:left;\"> Inferior STE, LBBB </td>\n   <td style=\"text-align:right;\"> 4 </td>\n  </tr>\n</tbody>\n</table>\n`````\n:::\n:::\n\nI hope this example could give you an idea to design and program your own calculator to solve problems that you're facing someday.\n\nThat's all !",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": [],
    "engineDependencies": {},
    "preserve": {},
    "postProcess": null
  }
}